<!DOCTYPE html>
<html lang="ja-JP">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="icon" type="image/x-icon" href="https://github.com/favicon.ico" />
    <link rel="stylesheet" type="text/css" href="/style.css" media="all" />
    <link rel="alternate" type="application/rss+xml" title="notions:iaarchiver - feed" href="/index.xml" />
    <title>notions:iaarchiver</title> 
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-42298279-1', 'iaarchiver.github.io');
      ga('send', 'pageview');
    </script>
</head>
  <body>
    <!-- .sidebar -->
    <div class="sidebar">
      <ul class="sidebar-nav">
        <li><a href="/"><span class="websymbolsliga icon boxedlist"></span></a></li>
        <li><a href="#" class="show-archive"><span class="websymbolsliga icon folder"></span></a></li>
      </ul>
      <hr>
      <input id="sidebar-search" placeholder=" search keywords..." />
      <hr>
      <ul class="sidebar-list">
      
        <li>
          <a href="/posts/2013-07-08-1730.html">
            Ubuntuでmpdのセットアップ
            <span class="date">2013-07-08 17:30</span>
            <span class="tag">mpd,ubuntu</span>
          </a>
        </li>
      
        <li>
          <a href="/posts/2013-07-08-2117.html">
            grunt-contrib-copyでのパス指定
            <span class="date">2013-07-08 21:17</span>
            <span class="tag">grunt,js</span>
          </a>
        </li>
      
        <li>
          <a href="/posts/2013-07-09-0731.html">
            GuitarPro6を64bit環境にインストールする
            <span class="date">2013-07-09 07:31</span>
            <span class="tag">guitarpro,ubuntu</span>
          </a>
        </li>
      
        <li>
          <a href="/posts/2013-07-09-1703.html">
            yacreader（のソースコード）をいじる
            <span class="date">2013-07-09 17:03</span>
            <span class="tag">ubuntu,yacreader</span>
          </a>
        </li>
      
        <li>
          <a href="/posts/2013-07-11-2000.html">
            Ubuntu13.04インストールおぼえがき
            <span class="date">2013-07-11 20:00</span>
            <span class="tag">ubuntu</span>
          </a>
        </li>
      
        <li>
          <a href="/posts/2013-07-11-2152.html">
            Ubuntu13.04でTimeCapsuleをマウントする
            <span class="date">2013-07-11 21:52</span>
            <span class="tag">ubuntu,timecapsule</span>
          </a>
        </li>
      
        <li>
          <a href="/posts/2013-07-29-0152.html">
            LinuxからDayOneの読み書きを行う
            <span class="date">2013-07-29 01:52</span>
            <span class="tag">dayone,jrnl</span>
          </a>
        </li>
      
      </ul>
    </div>
    <!-- [END] .sidebar -->

    <!-- .wrapper -->
    <div class="wrapper" style="height:100%">
    <!-- .logo -->
    <div class="logo">notions :: iaarchiver</div>
    <!-- [END] .logo -->
    <div class="post">
  <div class="post-info">
  <h1><a href="/posts/2013-07-09-1703.html">yacreader（のソースコード）をいじる</a></h1>
  <span class="date">July 9th 2013</span>
  <span class="author"></span>
  <hr>
  </div>
  <div class="post-content">
    <p><a href="http://www.yacreader.com/">yacreader</a>とは<a href="http://comix.sourceforge.net/">comix</a>よりもリッチな見栄えのコミックビューアです．iPhone版もリリースされて開発が活発なので利用してみました．</p>
<p>それでもまだ少し機能が足らないところがあったのでソースをいじったのでメモ．</p>
<h2>yacreaderのダウンロード</h2>
<p>Linux版ではlibpoppler-qt4が必要です．予め<code>sudo apt-get install libpoppler-qt4-dev</code>でインストールしておきます．本体は<a href="http://www.yacreader.com/downloads">こちら</a>からダウンロードすることができます．</p>
<h2>ソースコードをコンパイルする</h2>
<ol>
<li><p>現在はBitbucket上で開発されているようですのでそこからソースコードをクローンします．</p>
<pre><code> <span class="variable">$ </span>hg clone <span class="symbol">https:</span>/<span class="regexp">/bitbucket.org/luisangelsm</span><span class="regexp">/yacreader</code></pre>
</li>
<li><p>コンパイルにはlibpoppler-qt4-dev以外にもPhonon, libqt4-sql, libqt4-sql-sqliteなどが必要なようです．(INSTALL.txtで詳しい情報が確認できます．）僕の環境ではlibpoppler-qt4-devとphononのみでインストールが必要でした．</p>
<pre><code> $ su<span class="operator"><span class="keyword">do</span> apt-<span class="keyword">get</span> install libpoppler-qt4-dev phonon</code></pre>
</li>
<li><p>先程ダウンロードしたビルドパッケージ内の<code>utils</code>フォルダをクローンしたソースコードのフォルダにコピーします．</p>
<pre><code> <span class="variable">$ </span>cp -<span class="constant">R</span> ~<span class="regexp">/Downloads/</span><span class="constant">YACReader</span>-\* <span class="constant">X11</span>-x64-qt4/utils yacreader/</code></pre>
</li>
</ol>
<p>以上が完了したら以下を実行してコンパイルします．</p>
<pre><code><span class="variable">$ </span>.<span class="regexp">/compileX11.sh</code></pre>
<p>成功するとクローンしたフォルダ内に<code>YACReader- X11--qt4</code>というフォルダ作成され，中にutilsフォルダ，YACReader, YACReaderLibraryがあるはずです．</p>
<blockquote>
<p>コンパイルに失敗する場合<br>    - g++とかgccが無いって言われる → <code>sudo apt-get install build-essential</code><br>    - 入れたのにphononが無いって言われる → <code>qmake -v</code>でQtVersionが5になっているかも．<code>.compileX11.sh</code>をエディタで開き，<code>qmake</code>をすべて<code>qmake-qt4</code>に変えて再びコンパイルする．</p>
</blockquote>
<h2>ソースコードをいじる</h2>
<blockquote>
<p><strong> 以下，yacreader6.5.3をもとに変更を行なっています</strong></p>
</blockquote>
<p>現状のYACReaderでは少し機能の足らない部分があるのでソースコードをいじってしまいます．（これらの変更は今後開発が進めば必要なくなるかもしれません．）</p>
<ol>
<li><h3>見開き表示にしたときに左右ページの順序が逆になるのを直したい．（海外コミックは横書き＝左とじなため）</h3>
<p><code>yacreader/YACReader/render.cpp</code>の430行付近を以下のように変更．</p>
<pre><code> QImage auxImg(totalWidth,totalHeight,QImage::Format_RGB32)<span class="comment">;</span>
     QPainter painter(&amp;auxImg)<span class="comment">;</span>
 -    painter<span class="preprocessor">.drawImage</span>(QRect(<span class="number">0</span>,<span class="number">0</span>,width1,totalHeight),img)<span class="comment">;</span>
 -    if(!img2<span class="preprocessor">.isNull</span>())
 -        painter<span class="preprocessor">.drawImage</span>(QRect(width1,<span class="number">0</span>,width2,totalHeight),img2)<span class="comment">;</span>
 +    if(!img2<span class="preprocessor">.isNull</span>()){
 +        painter<span class="preprocessor">.drawImage</span>(QRect(<span class="number">0</span>,<span class="number">0</span>,width2,totalHeight),img2)<span class="comment">;</span>
 +        painter<span class="preprocessor">.drawImage</span>(QRect(width2,<span class="number">0</span>,width1,totalHeight),img)<span class="comment">;</span>
 +    }else{
 +        painter<span class="preprocessor">.drawImage</span>(QRect(<span class="number">0</span>,<span class="number">0</span>,width1,totalHeight),img)<span class="comment">;</span>
 +    }
     painter<span class="preprocessor">.end</span>()<span class="comment">;</span></code></pre>
</li>
<li><h3>ページ移動に必要なホイールの移動量を２目盛りから1目盛りへ変えたい．</h3>
<p><code>yacreader/YACReader/viewer.cpp</code>の370行付近を以下のように変更</p>
<pre><code> void Viewer::wheelEvent(QWheelEvent * event)
 {
     <span class="keyword">if</span>(render-&gt;hasLoadedComic())
     {
         <span class="keyword">if</span>((event-&gt;delta()&lt;<span class="number">0</span>)&amp;&amp;(verticalScrollBar()-&gt;sliderPosition()==verticalScrollBar()-&gt;maximum()))
         {
 -            <span class="keyword">if</span>(whellStop)
 +            <span class="keyword">if</span>(true)
             {
                 <span class="keyword">next</span>();
                 verticalScroller-&gt;stop();
                 event-&gt;accept();
                 wheelStop = false;
                 <span class="keyword">return</span>;
             }
             <span class="keyword">else</span>
                 wheelStop = true;
         }
         <span class="keyword">else</span>
         {
             <span class="keyword">if</span>((event-&gt;delta()&gt;<span class="number">0</span>)&amp;&amp;(verticalScrollBar()-&gt;sliderPosition()==verticalScrollBar()-&gt;minimum()))
             {
 -                <span class="keyword">if</span>(whellStop)
 +                <span class="keyword">if</span>(true)
                 {
                     prev();
                     verticalScroller-&gt;stop();
                     event-&gt;accept();
                     wheelStop = false;
                     <span class="keyword">return</span>;
                 }
                 <span class="keyword">else</span>
                     wheelStop = true;
             }
         }</code></pre>
</li>
<li><h3>カバーが横長の場合は90度回転して欲しい</h3>
<ul>
<li><p><strong>hardwareAccelarationなしのとき</strong><br><code>yacreader/common/pictureflow.cpp</code>の600行あたりを以下のように変更</p>
<pre><code>  static QImage* prepareSurface(const QImage* slideImage, int w, int h, QRgb bgcolor,
  PictureFlow::ReflectionEffect reflectionEffect)
  {

        int iw,ih<span class="comment">;</span>
    iw = slideImage-&gt;width()<span class="comment">;</span>
    ih = slideImage-&gt;height()<span class="comment">;</span>
    int psw,psh<span class="comment">;</span>
    if(iw&gt;ih)
    {
  -      psw = w<span class="comment">;</span>
  -      psh = w * (<span class="number">1.0</span>*ih/iw)<span class="comment">;</span>
  +      int w1 = w<span class="comment">;</span>
  +      psh = w1 * (<span class="number">1.0</span>*iw/ih)<span class="comment">;</span>
  +      psw = w1<span class="comment">;</span>

  +      while(psh&gt;h)
  +      {
  +        w1-=<span class="number">2</span><span class="comment">;</span>
  +        psh= w1* (<span class="number">1.0</span>*iw/ih)<span class="comment">;</span>
  +        psw = w1<span class="comment">;</span>
  +      }
    }
    else
    {
        int h1=h<span class="comment">;</span>
        psw = h1 * (<span class="number">1.0</span>*iw/ih)<span class="comment">;</span>
        psh = h1<span class="comment">;</span>

        while(psw&gt;w)
        {
              h1-=<span class="number">2</span><span class="comment">;</span>
             psw = h1 * (<span class="number">1.0</span>*iw/ih)<span class="comment">;</span>
             psh = h1<span class="comment">;</span>
        }
    }
    w = psw<span class="comment">;</span>

  <span class="preprocessor">#ifdef PICTUREFLOW_QT4</span>
    Qt::TransformationMode mode = Qt::SmoothTransformation<span class="comment">;</span>
  -   QImage img = slideImage-&gt;scaled(psw, psh, Qt::IgnoreAspectRatio, mode)<span class="comment">;</span>
  +  QImage img<span class="comment">;</span>
  +  if (iw &gt; ih){
  +    QTransform rot<span class="comment">;</span>
  +    rot<span class="preprocessor">.rotate</span>(<span class="number">90</span>)<span class="comment">;</span>
  +    img = slideImage-&gt;transformed(rot, Qt::SmoothTransformation)<span class="comment">;</span>
  +    img = img<span class="preprocessor">.scaled</span>(psw, psh, Qt::IgnoreAspectRatio, mode)<span class="comment">;</span>
  +  }else{
  +    img = slideImage-&gt;scaled(psw, psh, Qt::IgnoreAspectRatio, mode)<span class="comment">;</span>
  +  }</code></pre>
</li>
<li><p><strong> hardwareAccelarationありのとき</strong><br><code>common/yacreader_flow_gl.cpp</code>の380行付近を以下のように変更</p>
<pre><code>  void YACReaderFlowGL::drawCover(CFImage <span class="variable">*CF</span>)
  {
      float w = CF-&gt;width;
      float h = CF-&gt;height;

  +    w = <span class="number">1.8</span>f<span class="variable">*(</span>w/h);
  +    h = <span class="number">1.8</span>f;</code></pre>
<p>同ファイルの1240行付近を以下のように変更</p>
<pre><code>  <span class="comment">//</span>-<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span>
  <span class="comment">//ImageLoader</span>
  <span class="comment">//</span>-<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span>
  <span class="comment">QImage</span> <span class="comment">ImageLoaderGL::loadImage(const</span> <span class="comment">QString&amp;</span> <span class="comment">fileName)</span>
  <span class="comment">{</span>
      <span class="comment">QImage</span> <span class="comment">image;</span>
      <span class="comment">bool</span> <span class="comment">result</span> <span class="comment">=</span> <span class="comment">image</span>.<span class="comment">load(fileName);</span>

  <span class="literal">+</span>    <span class="comment">if</span> <span class="comment">(image</span>.<span class="comment">width()</span> &gt; <span class="comment">image</span>.<span class="comment">height())</span>
  <span class="literal">+</span>        <span class="comment">image</span> <span class="comment">=</span> <span class="comment">image</span>.<span class="comment">transformed(QMatrix()</span>.<span class="comment">rotate(90));</code></pre>
</li>
</ul>
</li>
</ol>
<p>ソースコードをいじったら再度<code>./compileX11.sh</code>を実行してコンパイルをすると変化が確認できます．</p>

  </div>

  <div class="navigation">
      
        <span class="newer"><a href="/posts/2013-07-11-2000.html">&#8672;&nbsp;newer</a></span>
      
      
        <span class="older"><a href="/posts/2013-07-09-0731.html">older&nbsp;&#8674;</a></span>
      
    </div>
  <div class="comments">
    
      <div id="disqus_thread"></div>
      <script type="text/javascript">
        window.disqus_identifier="";
        window.disqus_url="http://iaarchiver.github.io/posts/2013-07-09-1703.html";
        window.disqus_title="yacreader（のソースコード）をいじる";
      </script>
        <script type="text/javascript" src="http://disqus.com/forums/iaarchiver/embed.js"></script>
        <noscript><a href="http://iaarchiver.disqus.com/?url=ref">View the discussion thread.</a></noscript>
    
  </div>
</div>


      <div class="footer">
      Copyright iaarchiver, 2013.
      </div>
    </div>
    <!-- [END] .wrapper -->

    <!-- load JS -->
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
    <script type="text/javascript" src="/scripts.js"></script>
  </body>
</html>
